<h1>Editing Individual Review</h1>

<p id="notice"><%= notice %></p>
<h1><%= @individual_review.review.name %></h1>

<p>Date : <%= @individual_review.date %></p>
<p>Employee : <%= @individual_review.employee.email %></p>
<p>Reviewer : <%= @individual_review.reviewer.email %></p>


<% @individual_review.review.sections.group_by(&:portion).each do |portion, sections| %>
	<ul>
		<li><h2><%= portion.capitalize %></h2></li>
		<% sections.group_by(&:portion).each do |section, questions|%>
			<% sections.each do |section| %>
			<li><h3><%= section.title %></h3>
				<% section.questions.group_by(&:subsection).each do |subsection,questions| %>
					<h3><%= subsection %></h3> 
					<% questions.each do |question|%>
						<li><%= question.question_text %></li>
						<li>
							<% answer = question.answers.where(individual_review_id: @individual_review.id).first %>
							<h3><%= answer.answer %></h3>	
							<%= form_for(answer, remote: true, :authenticity_token => true, :html => {:id => "answer-#{question.id}", "data-id" => "#{answer.id}", :class => ''})  do |f| %>
								<% if question.question_type == 'check_box' %>
									<div class="form-group ">
				          	<%= f.collection_radio_buttons :answer, Answer::ANSWERS, :to_s, :humanize, class: 'form-control' %>
									</div>
								<% else %>
									<div class="form-group ">
				          	<%= f.text_field :answer, class: 'form-control' %>
									</div>
								<% end %>
				      <% end %>
				      <hr>
						</li>
					<% end %>	
				<% end %>
				<% section_answer = section.section_answers.where(individual_review_id: @individual_review.id).first %>
				<%= form_for(section_answer, remote: true, :authenticity_token => true, :html => {:id => "section-#{section.id}", "data-id" => "#{section_answer.id}", :class => ''})  do |f| %>
					<fieldset>
						<div class="form-group ">
							<%= f.label :employee_comment %><br>
	          	<%= f.text_field :employee_comment, class: 'form-control comment-js' %>
						</div>
						<div class="form-group ">
							<%= f.label :reviewer_comment %><br>
	          	<%= f.text_field :reviewer_comment, class: 'form-control comment-js' %>
						</div>
					</fieldset>
	      <% end %>
			</li>
			<% end%>
		<% end %>
		</li>
	</ul>
<% end%>

<%= render 'form' %>

<%= link_to 'Show', @individual_review %> |
<%= link_to 'Back', individual_reviews_path %>

<script>
	// AJAX to create or update each answer
		$('input:radio').on('change', function(){
			var answer_value = $(this).val()
			var answer_id = $(this).parent().parent().data('id')
			console.log(answer_id)
			console.log(answer_value)
			var question = $(this).parent().parent().attr('id').split('-').pop()
			var individual_review = <%= @individual_review.id %>
			$.ajax({
				url:'/answers/' + answer_id,
				type: 'put',
				data: {
					answer : {
						question_id : question,
						answer_value : answer_value,
						individual_review_id : individual_review,
						answer_id : answer_id
					}
				},
				dataType: 'script',
				success: function(){
					console.log('success')
				},
				error: function(error){
					console.log('error')
					console.log(error)
				}
			});
		});

		// AJAX to create or update each section comment
			$('.comment-js').on('change', function(){
				var comment_value = $(this).val()
				var section_answer_id = $(this).parent().parent().parent().data('id')
				console.log(section_answer_id)
				console.log(comment_value)
				var section_id = $(this).parent().parent().parent().attr('id').split('-').pop()
				var comment_type = $(this)[0].name.split('[')[1].slice(0,-1)
				console.log(comment_type)
				console.log(section_id)
				var individual_review = <%= @individual_review.id %>
				$.ajax({
					url:'/section_answers/' + section_answer_id,
					type: 'put',
					data: {
						section_answer : {
							comment_value : comment_value,
							comment_type : comment_type
							// individual_review_id : individual_review,
							// answer_id : answer_id
						}
					},
					dataType: 'script',
					success: function(){
						console.log('success')
					},
					error: function(error){
						console.log('error')
						console.log(error)
					}
				});
			});
</script>
